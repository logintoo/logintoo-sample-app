(()=>{"use strict";$(async function(){T();let e=y(),t=I();e&&(t=await _(e)),!t.accessToken&&t.refreshToken&&(t=await _(t));let o=t&&t.accessToken?t.accessToken:null;if(o){let r=await S(o);r&&E(r)}else k()});function T(){M.AutoInit(),L(),$("#signin-btn").off("click").click(function(){x()}),$("#signout-btn").off("click").click(function(){d()})}function y(){let e,t,o,r;try{let n=new URLSearchParams(window.location.search);e=n.get("code"),t=n.get("state"),o=n.get("language"),r=n.get("locale")}catch(n){throw c(n),new Error("Could not get URL search parameters")}if(e===null)return!1;if(t===null)return!1;let i=sessionStorage.getItem(client_id+"-state");return t!=i&&(P("Wrong State parameter. Please try again."),m(),location.reload()),console.log("Redirected response from the Auth Server detected."),{code:e,state:t,language:o,locale:r}}function I(){let e=localStorage.getItem(client_id+"-access_token"),t=localStorage.getItem(client_id+"-access_token_exp"),o=localStorage.getItem(client_id+"-refresh_token"),r=localStorage.getItem(client_id+"-refresh_token_exp"),i=Math.floor(Date.now()/1e3),n=30;return(!e||!t||t-i<n)&&(localStorage.removeItem(client_id+"-access_token"),localStorage.removeItem(client_id+"-access_token_exp"),e=!1,console.log("No valid Access token found in the Local Storage.")),(!o||!r||r-i<n)&&(localStorage.removeItem(client_id+"-refresh_token"),localStorage.removeItem(client_id+"-refresh_token_exp"),o=!1,console.log("No valid Refresh token found in the Local Storage.")),{accessToken:e,refreshToken:o}}async function _(e){$("#spinner-container").show(),$("#logged-in").show();let t=e.code,o=e.refreshToken,r=sessionStorage.getItem(client_id+"-code_verifier"),i,n;t&&!o&&(console.log("Trying to get new Access and Refresh tokens."),i={grant_type:"authorization_code",code:t,redirect_uri,client_id,code_verifier:r},n="POST"),o&&!t&&(console.log("Trying to refresh Access token and rotate Refresh token."),i={grant_type:"refresh_token",refresh_token:o},n="PATCH");let l;try{let u={method:n,url:tokenEndpointUri,data:i};l=await g(u)}catch(u){a("Could not get API data");return}let s=await l.json();if(!l.ok)return await v(l.status,s),{accessToken:null,refreshToken:null};t&&m();let f=s.access_token;localStorage.setItem(client_id+"-access_token",f),localStorage.setItem(client_id+"-access_token_exp",s.exp);let h=s.refresh_token;return localStorage.setItem(client_id+"-refresh_token",h),localStorage.setItem(client_id+"-refresh_token_exp",s.rt_exp),$("#access-token-log").show(),console.log("Tokens saved in the Local Storage."),{accessToken:f,refreshToken:h}}function m(){history.replaceState(null,"",redirect_uri),sessionStorage.removeItem(client_id+"-state"),sessionStorage.removeItem(client_id+"-code_verifier")}async function S(e){$("#spinner-container").show(),$("#logged-in").show(),console.log("Trying to get content from the Sample App API.");let t;try{let r={method:"GET",url:appApiUri,token:e};t=await g(r)}catch(r){a("Could not get API data");return}let o=await t.json();if(!t.ok){await v(t.status,o);return}return o}function E(e){if(console.log("LOGGED IN"),e.statusCode<200||e.statusCode>299)$("#error-details").html("Status Code: <b>"+e.statusCode+"</b><br>Error: <b>"+e.statusText+"</b>"),$("#logged-in").hide(),$("#signin-btn-container").show(),$("#error-4xx").show();else{let t="";t+=e.email?'<div class="truncate">Email: <b>'+e.email+"</b></div>":"",t+=e.email_normalized?'<div class="truncate">Normalized Email: <b>'+e.email_normalized+"</b></div>":"",t+=e.email_verified?"<div>Email Verified: <b>"+e.email_verified+"</b></div>":"",t+=e.hd?"<div>Home Domain: <b>"+e.hd+"</b></div>":"",t+=e.language?"<div>Language: <b>"+e.language+"</b></div>":"",t+=e.locale?"<div>Locale: <b>"+e.locale+"</b></div>":"",t+=e.iss?'<div class="truncate">iss: <b>'+e.iss+"</b></div>":"",t+=e.sub?'<div class="truncate">sub: <b>'+e.sub+"</b></div>":"",t+=e.aud?'<div class="truncate">aud: <b>'+e.aud+"</b></div>":"",t+=e.exp?"<div>exp: <b>"+e.exp+"</b> ("+new Date(e.exp*1e3).toLocaleString()+")</div>":"",t+=e.iat?"<div>iat: <b>"+e.iat+"</b> ("+new Date(e.iat*1e3).toLocaleString()+")</div>":"",t+=e.nbf?"<div>nbf: <b>"+e.nbf+"</b> ("+new Date(e.nbf*1e3).toLocaleString()+")</div>":"",t+=e.jti?'<div class="truncate">jti: <b>'+e.jti+"</b></div>":"",$("#sample-api-response").html(t),$("#sample-api-container").show(),$("#spinner-container").hide(),$("#signout-btn-container").show()}}function k(){console.log("LOGGED OUT"),$("#logged-in").hide(),$("#sample-api-response").empty(),$("#signout-btn-container").hide(),$("#signin-btn-container").show()}function d(){k();let e=localStorage.getItem(client_id+"-refresh_token");if(localStorage.removeItem(client_id+"-access_token"),localStorage.removeItem(client_id+"-access_token_exp"),localStorage.removeItem(client_id+"-refresh_token"),localStorage.removeItem(client_id+"-refresh_token_exp"),!e)return;console.log("Delete the auth record on the server.");try{g({method:"DELETE",url:tokenEndpointUri,data:{refresh_token:e}})}catch(t){console.log("Error while deleting auth record",t)}console.log("FINISH")}function b(){try{let e=new Uint8Array(32);return crypto.getRandomValues(e),w(e)}catch(e){throw c(e),new Error("Could not generate random value.")}}async function C(e){try{let t=Uint8Array.from(e,i=>i.charCodeAt(0)),o=await crypto.subtle.digest("SHA-256",t),r=new Uint8Array(o);return w(r)}catch(t){throw c(t),new Error("Could not get a hash of the string.")}}function w(e){let t="";for(let o=0,r=e.length;o<r;o++)t+=String.fromCharCode(e[o]);return t=window.btoa(t),t=t.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),t}function U(){let e=sessionStorage.getItem(client_id+"-code_verifier");e||(e=b(),sessionStorage.setItem(client_id+"-code_verifier",e));let t=sessionStorage.getItem(client_id+"-state");return t||(t=b(),sessionStorage.setItem(client_id+"-state",t)),{code_verifier:e,state:t}}async function x(){let e="https://"+authServer+"/"+authApiVersion+"/";try{$("#signin-btn").addClass("disabled");let{code_verifier:t,state:o}=U(),r=await C(t),i=new URL(redirect_uri),n=new URL(e);n.searchParams.set("response_type","code"),n.searchParams.set("client_id",client_id),n.searchParams.set("redirect_uri",i.toString()),n.searchParams.set("state",o),n.searchParams.set("code_challenge",r),n.searchParams.set("code_challenge_method","S256"),typeof language!="undefined"&&language&&n.searchParams.set("language",language),typeof locale!="undefined"&&locale&&n.searchParams.set("locale",locale),window.location.assign(n.toString())}catch(t){throw c(t),new Error("Could not send a request to the Authorization server.")}}function g(e){let{method:t,url:o,data:r,token:i}=e;try{let n={method:t,headers:{"Content-Type":"application/json"}};return i&&(n.headers.Authorization="Bearer "+i),t!="GET"&&t!="HEAD"&&r&&(n.body=JSON.stringify(r)),fetch(o,n)}catch(n){c(n)}}function c(e){console.error("Bad Browser:",e),$("#signin-btn-container").hide(),$("#sample-api-response").empty(),$("#logged-in").hide(),$("#signout-btn-container").hide(),$("#bad-browser").show()}function P(e){if(e){var t=JSON.parse(sessionStorage.getItem(client_id+"-waitingToasts"));Array.isArray(t)?t.push(String(e)):t=[String(e)],sessionStorage.setItem(client_id+"-waitingToasts",JSON.stringify(t))}}function L(){let e=JSON.parse(sessionStorage.getItem(client_id+"-waitingToasts"));if(Array.isArray(e))for(let t=0,o=e.length;t<o;t++)a(e[t],6e3);sessionStorage.removeItem(client_id+"-waitingToasts")}async function v(e,t){console.error("API Failed:",t),isNaN(e)&&a("API Error",6e4),e>=400&&e<=499&&(t.error_description?a(t.error_description,6e4):t.statusText&&a(t.statusText,6e4),d()),e>=500&&e<=599&&(a("Internal Server Error",6e4),d())}function a(e,t){console.error("Error:",e);let o="";typeof e=="string"&&(o=e),typeof e=="object"&&(o=e.message),o||(o="Something went wrong"),M.toast({html:o,displayLength:t})}})();
/*!
* Logintoo Sample App (https://sample.logintoo.com)
* Copyright (c) 2020, Eduard Moskvin
* BSD 3-Clause License (https://raw.githubusercontent.com/logintoo/logintoo-sample-app/main/LICENSE)
*/
